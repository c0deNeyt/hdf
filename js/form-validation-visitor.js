

// Example starter JavaScript for disabling form submissions if there are invalid fields
(function () {
  'use strict'

  // Fetch all the forms we want to apply custom Bootstrap validation styles to
  var forms = document.querySelectorAll('.needs-validation')
 
  // Loop over them and prevent submission
  Array.prototype.slice.call(forms)
    .forEach(function (form) {
      form.addEventListener('submit', function (event) {
        var visitortype     = $('#visitortype').val();
        var btemp           = $("input[name='btemp']").val();
        var fname           = $("input[name='fname']").val();
        var coname          = $("input[name='coname']").val();
        var contactnumber   = $("input[name='contactnumber']").val();
        var address         = $("input[name='address']").val();
        var time            = $('#time').val();
        var date            = $('#date').val();
        var symptoms        = $("input[name='symptoms']:checked").val();
        var travelled       = $("input[name='travelled']:checked").val();
        var tempTravLoc     = document.getElementById("travloc");
        var travloc = null;

        if (tempTravLoc) {
          travloc =  tempTravLoc.value.toUpperCase();
        };
        var storedEmailFormat = new emails();
        var sweetAlerts = new alerts();
        // FUNCTION THAT HANDLES THE FORMAT OF EMAILS
        function emails() {
          this.employeeEmailFormat = function(subjectMsg){
            // console.log("Email sent with subject |", subjectMsg);
            // ** Email API format that employee have a COVID19 symptoms!
            Email.send({
              Host: "smtp.gmail.com",
              Username : "telford.mis.hdf.developer@gmail.com",
              Password : "ofdtqxrgwapczvet",
              // To : "mariarizalinacortez@astigp.com, leelipkeng@astigp.com, mellobo@astigp.com, charitylanceta@astigp.com, ivenponiente@astigp.com, telford_clinic_ph@astigp.com, telford_mis_ph@astigp.com",
              // To : "telford_mis_ph@astigp.com",
              To : "chanchristianarana@gmail.com",
              From : "telford.mis.hdf.developer@gmail.com",
              Subject : subjectMsg,
              Body : "To whom it may concern,"+
              "<br/>" + "<br/>" + "<br/>" +
              "Please accept this letter as notification regarding our visitor." +
              "<br/>" +
              "Kindly see details below for your reference."+
              "<br/>" + "<br/>" +
              "Visitor Type : " + ' ' + visitortype + "<br/>" +
              "Visitor's Name : " + ' ' + fname + "<br/>" + 
              "Body temperature : " + ' ' + btemp + "<br/>" +
              "Symptoms :   " + symptoms + "<br/>" + 
              "Inputted travel location : " + " " + travloc + "<br/>" + 
              "Company Name : " + ' ' + coname + "<br/>" +
              "Contact Number : " + ' ' + contactnumber + "<br/>" +
              "Address : " + ' ' + address + "<br/>" +
              "Time and Date of Declaration : " + ' ' + date + ' ' + ' ' + time + 
              "<br/>"+ "<br/>"+ "<br/>"+
              "Note:" + 
              "<br/>"+
              "ðŸ˜¼ This mail is autogenerated by the HDF System. Please do not reply directly.. ðŸ˜¼" + 
              "<br/>"+ "<br/>",
            });// </ END OF EMAIL
          };
        }; /*END OF FUNCTION THAT HANDLES THE FORMAT OF EMAILS*/
        // FUNCTION THAT HANDLES THE ALERT FORMATS
        function alerts(){
          // ** Function responsible to handle alert message to those
          //employee with symptoms of COVID19
          function withSympAlertLayout(str){
            const wrapper     = document.createElement('div');
                  wrapper.innerHTML ="<span style='font-size: 18px; color:red; text-transform:uppercase; font-family: Arial, Helvetica, sans-serif;'>" + str + "</span>" + "<br>"+ "<br>"+
                              "Please inform the SECURITY PERSONNEL to call the nurse\n"+
                              "on duty for assessment and proceed to the isolation area. And don't worry &#8221Every thing gonna be all right!&#8221"  + "<br>" + "<br>"+ "<br>";
            return wrapper;
          };
          // ** SUCCESS ALERT SCRIPT
          this.successDeclaration = function(){
           visitorInsertData();
            // FORMAT FOR HTML CONTENT
            const wrapper     = document.createElement('div');
            wrapper.innerHTML = "<span style='font-size: 1.4rem; text-transform:uppercase; font-family: Arial, Helvetica, sans-serif;'>" +
                    "Company Name:" + " " + coname + "</span>" + "<br>" +
                    "<span style='font-family: Arial, Helvetica, sans-serif;'>&#8221You are making a difference.&#8221</span>" + "<br>" +
                    "I wish your are always healthy and safe. ðŸ™‚" + "<br><br>" +
                    "Your data successfully saved on the day of " + "<br>" +
                    "<span style='font-size: 1.6rem; font-weight: bold; color: #00D100; text-transform:uppercase; font-family: Arial, Helvetica, sans-serif;'>" +
                    date + " " + time + "</span>";
            // SWEET ALERT FOR VALID HDR DATA
            Swal.fire({
              title: 'Thank you \n'  + fname.toUpperCase() ,
              html: wrapper,
              icon: "success",
              background: '#fff',
              width: 600,
              allowOutsideClick: false,
              allowEscapeKey: false,
              confirmButtonColor: "#22BB33",
              confirmButtonText: '<i class="fa fa-thumbs-up"></i> Great!',
              backdrop: `
                rgba(10, 209, 60, 0.50)
                url("../img_ico/img/party-popper1.gif")
                bottom left
                no-repeat
              `
            })
            .then((result)=>{
              if(result.isConfirmed){
                window.location.href = "../v/index.php";
              }
            }); /* ALERT ENDS HERE */

          };
          // ** High body temperature and with covid symptoms
          // alert script
          this.covid19SymptomsDetected = function (str){
            Swal.fire({
              title: 'Are you sure?',
              html: "Detected COVID19 symptoms with <br>" + "<span style='font-size: 3rem; color:red; font-family: Arial, Helvetica, sans-serif;'>" + btemp + "&#x2103 </span><br>" + "body temperature!",
              icon: 'warning',
              showCancelButton: true,
              backdrop: "rgba(209, 10, 10, 0.77)",
              confirmButtonColor: '#22BB33',
              cancelButtonColor: '#d33',
              confirmButtonText: 'Yes, declare!',
              cancelButtonText: 'Do not declare'
            }).then((result) => {
              if (result.isConfirmed) {
               visitorInsertData();
                let btemp           = document.getElementById('btemp').value 
                let checkRadio      = document.querySelector('#symp_toms:checked');
                let msgFormat = withSympAlertLayout(str);
                let emailSubject = "Visitor having COVID19 Symptoms and Higher Body Temperature than Normal.";
                let emailSubject1 = "Visitor having Higher Body Temperature than Normal";
                let emailSubject2 = "Visitor having COVID19 Symptoms.";
                // ** IF statements to check what kind of email should the system
                // will send 
                if (checkRadio != null  && btemp >= 37.60){ //HIGHER BODY TEMP AND HAVE SYMPTOMS
                  storedEmailFormat.employeeEmailFormat(emailSubject);
                }
                else if (btemp >= 37.60 && checkRadio == null){ // HIGHER BODY TEMP
                  storedEmailFormat.employeeEmailFormat(emailSubject1);
                }
                else if (btemp <= 37.50 && checkRadio != null ){ // WITH SYMPTOMS
                  storedEmailFormat.employeeEmailFormat(emailSubject2);
                }; /* if else condition ends here! */
                // ** ALERT WHEN USER DECLARE THE DATA WITH COVID19 SYMPTOMS
                Swal.fire({
                  icon: 'warning',
                  title: 'WARNING!',
                  html: msgFormat,
                  backdrop: "rgba(209, 10, 10, 0.77)",
                  allowOutsideClick: false,
                  allowEscapeKey: false,
                  allowEnterKey: false,
                  showConfirmButton: false,
                }); /* ALERT ENDS HERE */
              }
              else if (
              /* CANCEL EVENT SCRIPT */
              result.dismiss === Swal.DismissReason.cancel
              ) {
                Swal.fire({
                  title: 'Cancelled',
                  text: "Data unsaved and email not sent ! ðŸ˜¿",
                  icon: 'error',
                  backdrop: "rgba(209, 10, 10, 0.77)",
                  confirmButtonColor: '#22BB33',
                });
              }
            });
          };
        };/*END OF FUNCTION THAT HANDLES THE ALERT FORMATS*/

        // Function responsible for sending data to the database
        function visitorInsertData(){
          $.ajax({
            type: 'POST',
            url: '../php/process-visitor.php',
            data: { visitortype: visitortype,
                    btemp: btemp,
                    fname: fname,
                    coname: coname,
                    contactnumber: contactnumber,
                    address: address,
                    time: time,
                    date: date,
                    symptoms: symptoms,
                    travelled: travelled,
                    travloc: travloc},
            cache : false,
            error: function (){
              Swal.fire({
                icon: 'error',
                title: 'Oops...',
                backdrop: "rgba(209, 10, 10, 0.77)",
                allowOutsideClick: false,
                allowEscapeKey: false,
                text: 'Something went wrong data not save!',
              })
            },
          });
        }; /* FUNCTION FOR INSERTING DATA ENDS HERE */

        // Function responsible for handling alert in different situation
        function alertExecute(){
          var btemp           = document.getElementById('btemp').value 
          var checkRadio      = document.querySelector('#symp_toms:checked');
          let str1 = "You have COVID19 symptoms and higher body temperature than normal.";
          let str2 = "Your body temperature is higher than normal.";
          let str3 = "You have COVID19 symptoms.";
          // ** Condition before sending alerts 
          // ** This if else statement will recognize what kind of
          // alert will be going to popup.
          if (checkRadio != null  && btemp >= 37.60){ //HIGHER BODY TEMP AND HAVE SYMPTOMS
            sweetAlerts.covid19SymptomsDetected(str1);
          }
          else if (btemp >= 37.60 && checkRadio == null){ // HIGHER BODY TEMP
            sweetAlerts.covid19SymptomsDetected(str2);
          }
          else if (btemp <= 37.50 && checkRadio != null ){ // WITH SYMPTOMS
            sweetAlerts.covid19SymptomsDetected(str3);
          }
          else {
            sweetAlerts.successDeclaration();
          }
        }; /* Function alertExecute ends here */
        // CHECKING THE VALIDITY OF INPUTS INSIDE FORM
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }  
      else {
        event.preventDefault();
        alertExecute();
      }; 
      form.classList.add('was-validated')
      }, false)
    })
})()

